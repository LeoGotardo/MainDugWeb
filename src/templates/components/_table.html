{% set userDict = current_user.to_dict() %}
{% if userDict.userType == 'User' %}
{% set safeJSON = {'userId': userDict['userId'], 'role': userDict['role'], 'type': userDict['userType']} %}
{% elif userDict.userType == 'Store' %}
{% set safeJSON = {'userId': userDict['storeId'], 'role': userDict['role'], 'type': userDict['userType']} %}
{% endif %}

<div class="table-container">
<!-- Dynamic Table -->
        <div class="table-container">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr id="tableHeader">
                        <!-- Headers will be populated by JavaScript -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentUserData = {};
        try {
            // Tentativa de parsear como JSON (método recomendado)
            currentUserData = JSON.parse('{{ safeJSON | tojson | safe }}');
        } catch (e) {
            // Fallback se não for JSON (menos ideal, pode falhar com dados complexos)
            console.warn("current_user não foi passado como JSON. Usando fallback.");
            // Tenta extrair role e type de uma representação string (ex: <User 1: admin>)
            const userString = '{{ current_user }}'; 
            currentUserData.role = userString.includes('super') ? 'super' : (userString.includes('admin') ? 'admin' : 'user'); // Inferência básica
            currentUserData.type = userString.includes('Store') ? 'Store' : 'User'; // Inferência básica
            // Adicione o userId se possível extrair
            const matchId = userString.match(/(\d+)/);
            if (matchId) currentUserData.userId = parseInt(matchId[1], 10);
        }
        const currentUser = currentUserData;
        const isSuper = currentUser.role === 'super' || currentUser.role === 'sysAdmin';
        const isAdminOrStore = currentUser.role === 'admin' || currentUser.type === 'Store';
        // --- FIM Autenticação: Dados do Usuário --- 

        // Configuration for different item types
        const tableConfigs = {
            user: {
                columns: [
                    { key: 'name', label: 'Nome', sortable: true },
                    { key: 'role', label: 'Função', sortable: true },
                    { key: 'document', label: 'CPF', sortable: false },
                    { key: 'role', label: 'Função', sortable: true },
                    { key: 'cardId', label: 'Cartão', sortable: false },
                    { key: 'hasSiteAccess', label: 'Acesso ao Site', sortable: true, type: 'boolean' },
                    { key: 'enabled', label: 'Ativo', sortable: true, type: 'boolean' },
                    { key: 'credit', label: 'Crédito', sortable: true, type: 'currency' },
                    ...(isSuper ? [
                            { key: 'deleted', label: 'Excluído', sortable: true, type: 'boolean' },
                            { key: 'store.name', label: 'Loja', sortable: true },
                        ] : []),
                ],
                actions: ['edit', 'logs', ...(isSuper ? ['delete'] : [])], // Apenas Super pode ver o botão delete
                editUrl: (item) => `{{ url_for('editUser', userId='USER_ID') }}`.replace('USER_ID', item.userId),
                logsUrl: (item) => `{{ url_for('logList', type='user', itemId='ID') }}`.replace('ID', item.userId),
                deleteUrl: (item) => `/deleteUser/${item.userId}`,
                // Lógica canDelete agora verifica se o usuário logado é Super
                canDelete: (item) => isSuper && 
                                   currentUser.userId !== item.userId && 
                                   item.deletable !== false
            },
            rpi: {
                columns: [
                    // Colunas restritas a Super
                    ...(isSuper ? [
                        { key: 'rpiId', label: 'ID', sortable: true },
                        { key: 'mac', label: 'MAC', sortable: true },
                        { key: 'store.name', label: 'Loja', sortable: true },
                        { key: 'deleted', label: 'Excluído', sortable: true, type: 'boolean' },
                    ] : []),
                    // Colunas visíveis para todos (Super, Admin, Store)
                    { key: 'name', label: 'Nome', sortable: true },
                    { key: 'enabled', label: 'Ativo', sortable: true, type: 'boolean' },
                    { key: 'ip', label: 'IP', sortable: true },
                    { key: 'sellCount', label: 'Vendas', sortable: true }
                ],
                actions: ['edit', 'logs', ...(isSuper ? ['delete'] : [])], // Apenas Super pode ver o botão delete
                editUrl: (item) => `{{ url_for('editRpi', rpiId='ID') }}`.replace('ID', item.rpiId),
                logsUrl: (item) => `{{ url_for('logList', type='rpi', itemId='ID', userId='USER_ID') }}`.replace('ID', item.rpiId).replace('USER_ID','{{ userId }}'),
                deleteUrl: (item) => `/deleteRpi/${item.mac}`
            },
            tap: {
                columns: [
                    ...(isSuper ? [
                        { key: 'tapId', label: 'ID', sortable: true },
                        { key: 'deleted', label: 'Excluído', sortable: true, type: 'boolean' },
                    ] : []),
                    { key: 'tapName', label: 'Nome', sortable: true },
                    { key: 'constant', label: 'Constante', sortable: true },
                    { key: 'volume', label: 'Volume', sortable: true },
                    { key: 'fixVol', label: 'Volume Fixo', sortable: true, type: 'boolean' },
                    { key: 'enabled', label: 'Ativo', sortable: true, type: 'boolean' },
                ],
                actions: ['edit', 'logs', ...(isSuper ? ['delete'] : [])], // Apenas Super pode ver o botão delete
                editUrl: (item) => `{{ url_for('editTap', tapId='ID') }}`.replace('ID', item.tapId),
                logsUrl: (item) => `{{ url_for('logList', type='tap', itemId='ID', userId='USER_ID') }}`.replace('ID', item.tapId).replace('USER_ID','{{ userId }}'),
                deleteUrl: (item) => `/deleteTap/${item.rpi.storeId}/${item.tapId}`
            },
            store: {
                // Esta seção só será acessível por Super (devido ao controle de abas)
                columns: [
                { key: 'name', label: 'Nome', sortable: true },
                { key: 'login', label: 'Login', sortable: true },
                { key: 'cardType', label: 'Tipo Cartão', sortable: true },
                { key: 'enabled', label: 'Ativo', sortable: true, type: 'boolean' },
                { key: 'role', label: 'Role', sortable: true },
                { key: 'sellCount', label: 'Vendas', sortable: true },
                { key: 'deleted', label: 'Excluído', sortable: true, type: 'boolean' },
                ],
                actions: ['edit', 'logs', 'delete'], // Super pode editar e deletar lojas
                editUrl: (item) => `{{ url_for('editStore', storeId='STORE_ID') }}`.replace('STORE_ID', item.storeId),
                logsUrl: (item) => `{{ url_for('logList', type='store', item_id='STORE_ID', user_id='USER_ID') }}`.replace('STORE_ID', item.storeId).replace('USER_ID','{{ userId }}'),
                deleteUrl: (item) => `/deleteStore/${item.storeId}`
            },
            product: {
                columns: [
                    { key: 'name', label: 'Nome', sortable: true },
                    { key: 'value', label: 'Valor', sortable: true, type: 'currency' },
                    { key: 'composition', label: 'Composição', sortable: false },
                    // Mostrar loja apenas para Super (Admin/Store já sabem a loja ou não precisam ver)
                    ...(isSuper ? [{ key: 'store.name', label: 'Loja', sortable: true },
                    { key: 'tapId', label: 'ID', sortable: true },
                    { key: 'deleted', label: 'Excluído', sortable: true, type: 'boolean' },
                ] : [])],
                actions: ['edit', 'delete'], // Todos podem ver botões (Super, Admin, Store)
                editUrl: (item) => `{{ url_for('editProduct', productId='PRODUCT_ID') }}`.replace('PRODUCT_ID', item.productId),
                deleteUrl: (item) => `/deleteProduct/${item.productId}`
            },
            route: {
                // Esta seção só será acessível por Super (devido ao controle de abas)
                columns: [
                    { key: 'routeId', label: 'ID', sortable: true },
                    { key: 'deleted', label: 'Excluído', sortable: true, type: 'boolean' },
                    { key: 'name', label: 'Nome', sortable: true },
                    { key: 'method', label: 'Método', sortable: true },
                    { key: 'url', label: 'URL', sortable: false },
                    { key: 'flag', label: 'Flag', sortable: true },
                    { key: 'description', label: 'Descrição', sortable: false }
                ],
                actions: ['edit', 'delete'], // Super pode editar e deletar rotas
                editUrl: (item) => `{{ url_for('editRoute', routeId='ROUTE_ID') }}`.replace('ROUTE_ID', item.routeId),
                deleteUrl: (item) => `/deleteRoute/${item.routeId}`
            },
            integration: {
                // Esta seção só será acessível por Super (devido ao controle de abas)
                columns: [
                    { key: 'integrationId', label: 'ID', sortable: true },
                    { key: 'deleted', label: 'Excluído', sortable: true, type: 'boolean' },
                    { key: 'name', label: 'Nome', sortable: true },
                    { key: 'description', label: 'Descrição', sortable: false },
                    { key: 'url', label: 'Url Base', sortable: false },
                    { key: 'documentation', label: 'Documentação', sortable: false }
                ],
                actions: ['edit', 'delete'], // Super pode editar e deletar rotas
                editUrl: (item) => `{{ url_for('editIntegration', integrationId='INTEGRATION_ID') }}`.replace('INTEGRATION_ID', item.integrationId),
                deleteUrl: (item) => `/deleteIntegration/${item.integrationId}`
            }
        };

        // Data passed from Flask
        const itemType = '{{ itemType }}';
        const items = JSON.parse('{{ items | tojson | safe }}');
        // currentUser já definido acima

        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => current && current[key], obj);
        }

        function formatCellValue(value, type) {
            if (value === null || value === undefined || value != '0' && value == '') return '-';
            
            switch (type) {
                case 'boolean':
                    return value ? 
                        '<span class="status-badge status-active">Sim</span>' :
                        '<span class="status-badge status-inactive">Não</span>';
                case 'currency':
                    return new Intl.NumberFormat('pt-BR', { 
                        style: 'currency', 
                        currency: 'BRL' 
                    }).format(value);
                default:
                    // Limita o comprimento de strings longas para melhor visualização
                    if (typeof value === 'string' && value.length > 50) {
                        return value.substring(0, 47) + '...';
                    }
                    return value;
            }
        }

        function populateTable() {
            const config = tableConfigs[itemType];
            // Se não há config (ex: Admin tentando ver 'store'), não faz nada
            if (!config) {
                console.warn(`Configuração não encontrada ou não permitida para itemType: ${itemType}`);
                // Opcional: Mostrar mensagem ao usuário
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '<tr><td colspan="100%">Acesso não permitido a esta seção.</td></tr>';
                // Limpar cabeçalho também
                const headerRow = document.getElementById('tableHeader');
                headerRow.innerHTML = '';
                return;
            }

            // Populate headers
            const headerRow = document.getElementById('tableHeader');
            headerRow.innerHTML = '';
            
            config.columns.forEach(col => {
                const th = document.createElement('th');
                if (col.sortable) {
                    th.innerHTML = `<button class="sort-btn" onclick="sortTable('${col.key}')">${col.label}</button>`;
                } else {
                    th.textContent = col.label;
                }
                headerRow.appendChild(th);
            });

            // Add actions header if there are actions defined
            if (config.actions && config.actions.length > 0) {
                const actionsHeader = document.createElement('th');
                actionsHeader.textContent = 'Ações';
                headerRow.appendChild(actionsHeader);
            }

            // Populate rows
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (!items || items.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="100%">Nenhum item encontrado.</td></tr>';
                 return;
            }

            items.forEach(item => {
                const row = document.createElement('tr');
                
                // Data columns
                config.columns.forEach(col => {
                    const td = document.createElement('td');
                    const value = getNestedValue(item, col.key);
                    td.innerHTML = formatCellValue(value, col.type);
                    // Adiciona title para strings longas truncadas
                    if (typeof value === 'string' && value.length > 50) {
                        td.title = value; 
                    }
                    row.appendChild(td);
                });

                // Actions column (only if actions are defined)
                if (config.actions && config.actions.length > 0) {
                    const actionsCell = document.createElement('td');
                    actionsCell.className = 'actions';
                    
                    config.actions.forEach(action => {
                        const button = createActionButton(action, item, config);
                        if (button) actionsCell.appendChild(button);
                    });
                    row.appendChild(actionsCell);
                }
                tbody.appendChild(row);
            });
        }

        function createActionButton(action, item, config) {
            const button = document.createElement('button');
            button.className = 'btn btn-sm me-1';

            let url = null;
            let requiresConfirmation = false;
            let confirmationMessage = '';

            switch (action) {
                case 'edit':
                    button.className += ' btn-warning';
                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/></svg>';
                    url = config.editUrl(item);
                    button.onclick = () => window.location.href = url;
                    break;
                    
                case 'logs':
                    button.className += ' btn-primary';
                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-activity" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M6 2a.5.5 0 0 1 .47.33L10 12.036l1.53-4.208A.5.5 0 0 1 12 7.5h3.5a.5.5 0 0 1 0 1h-3.15l-1.88 5.17a.5.5 0 0 1-.94 0L6 3.964 4.47 8.171A.5.5 0 0 1 4 8.5H.5a.5.5 0 0 1 0-1h3.15l1.88-5.17A.5.5 0 0 1 6 2"/></svg>';
                    url = config.logsUrl(item);
                    button.onclick = () => window.location.href = url;
                    break;
                    
                case 'delete':
                    button.className += ' btn-danger';
                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>';
                    
                    // Check permissions for delete using canDelete if available
                    let canDeleteItem = true;
                    if (config.canDelete) {
                        canDeleteItem = config.canDelete(item);
                    }
                    
                    if (!canDeleteItem) {
                        button.disabled = true;
                        button.title = "Você não tem permissão para excluir este item."; // Tooltip
                        return button;
                    }
                    
                    url = config.deleteUrl(item);
                    requiresConfirmation = true;
                    const itemName = {
                        user: 'usuário',
                        rpi: 'RPI',
                        store: 'loja',
                        product: 'produto',
                        route: 'rota'
                    }[itemType] || 'item';
                    confirmationMessage = `Tem certeza que deseja excluir este ${itemName}?`;

                    button.onclick = () => {
                        if (confirm(confirmationMessage)) {
                            fetch(url, {
                                method: 'DELETE',
                                headers: { 'Content-Type': 'application/json' }
                            })
                            .then(response => {
                                if (response.ok) {
                                    // Recarrega a página ou remove a linha da tabela
                                    window.location.reload(); 
                                } else {
                                    alert(`Erro ao excluir o item.\n${response.msg}`);
                                }
                            })
                            .catch(error => {
                                console.error('Erro na exclusão:', error);
                                alert('Erro ao excluir o item.');
                            });
                        }
                    };
                    break;
                    
                default:
                    return null;
            }

            return button;
        }

        function sortTable(column) {
            const tbody = document.getElementById('tableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const config = tableConfigs[itemType];
            
            const columnIndex = config.columns.findIndex(col => col.key === column);
            if (columnIndex === -1) return;

            // Basic sort direction toggle (optional)
            let currentSort = headerRow.querySelector(`button[onclick="sortTable('${column}')"]`).dataset.sortDir || 'asc';
            let newSort = currentSort === 'asc' ? 'desc' : 'asc';
            headerRow.querySelector(`button[onclick="sortTable('${column}')"]`).dataset.sortDir = newSort;

            rows.sort((a, b) => {
                const aValue = getNestedValue(items.find(it => it.id === a.dataset.itemId), column); // Requires item ID on row
                const bValue = getNestedValue(items.find(it => it.id === b.dataset.itemId), column); // Requires item ID on row
                
                // Basic comparison, needs improvement for types (numeric, date, etc.)
                let comparison = 0;
                if (aValue > bValue) {
                    comparison = 1;
                } else if (aValue < bValue) {
                    comparison = -1;
                }
                return newSort === 'asc' ? comparison : comparison * -1;
            });

            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            // Note: Sorting logic needs refinement to handle data types and potentially fetch sorted data from backend.
        }

        // Initial population
        document.addEventListener('DOMContentLoaded', populateTable);

    </script>
</div>