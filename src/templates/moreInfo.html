{% extends "base.html" %}
{% block title %}Logs - {{ passwordInfo.site if passwordInfo else 'Detalhes' }} - MainDug{% endblock %}

{% block content %}
<div id="page-moreInfo">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Logs da Credencial: {{ passwordInfo.site if passwordInfo else 'N/A' }}</h1>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Voltar ao Dashboard</a>
    </div>
    
    <div class="content-box mb-4">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Usuário:</strong> {{ passwordInfo.user or 'N/A' }}</p>
                <p><strong>Flags:</strong> 
                    {% for flag in passwordInfo.flags %}
                        <span class="badge bg-flag me-1">{{ flag }}</span>
                    {% endfor %}
                </p>
            </div>
            <div class="col-md-6 text-md-end">
                <p><strong>ID da Credencial:</strong> {{ passwordInfo.id or 'N/A' }}</p>
                <p><strong>Status de Vazamento:</strong> 
                    {% if passwordInfo.status %}
                        <span class="badge bg-danger">VAZADA</span>
                    {% else %}
                        <span class="badge bg-success">Segura</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <h2 class="h4 mb-3">Histórico de Ações</h2>
    <div class="content-box p-0">
        <div class="table-responsive">
            <table class="table table-hover table-borderless mb-0">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="checkAllLogs" class="form-check-input"></th>
                        <th>Data</th>
                        <th>Ação</th>
                        <th>Usuário</th>
                        <th>Detalhes</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody">
                    {% for log in passwordInfo.logs %}
                    <tr>
                        <td><input type="checkbox" name="logs" value="{{ log.id }}" class="form-check-input log-checkbox"></td>
                        <td class="text-nowrap">{{ log.timestamp | datetimeformat }}</td>
                        <td><span class="badge bg-{{ log.severity_class }}">{{ log.action }}</span></td>
                        <td>{{ log.user.login if log.user else 'Sistema' }}</td>
                        <td>{{ log.details }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <button type="button" id="deleteLogsBtn" class="btn btn-danger mt-3" data-password-id="{{ passwordInfo.id }}">
        <i class="bi bi-trash-fill"></i> Excluir Logs Selecionados
    </button>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkAll = document.getElementById('checkAllLogs');
        const checkboxes = document.querySelectorAll('.log-checkbox');
        const deleteBtn = document.getElementById('deleteLogsBtn');
        const passwordId = deleteBtn.getAttribute('data-password-id');

        checkAll.addEventListener('change', function() {
            checkboxes.forEach(cb => cb.checked = checkAll.checked);
        });

        checkboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                if (!this.checked) {
                    checkAll.checked = false;
                }
            });
        });

        deleteBtn.addEventListener('click', function() {
            const selectedLogs = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            if (selectedLogs.length === 0) {
                alert('Selecione pelo menos um log para excluir.');
                return;
            }

            if (confirm(`Tem certeza que deseja excluir ${selectedLogs.length} logs?`)) {
                // Requisição DELETE usando Fetch API
                fetch('{{ url_for("moreInfo") }}', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'logs': selectedLogs 
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        window.location.reload(); // Recarrega a página para atualizar a lista
                    } else {
                        alert(`Erro: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Erro na exclusão:', error);
                    alert('Erro ao comunicar com o servidor.');
                });
            }
        });
    });
</script>
{% endblock %}