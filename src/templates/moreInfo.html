{% extends "base.html" %}
{% block title %}Logs - {{ passwordInfo.site if passwordInfo else 'Detalhes' }} - MainDug{% endblock %}

{% block content %}
<div id="page-moreInfo">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Logs da Credencial: {{ passwordInfo.site if passwordInfo else 'N/A' }}</h1>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar ao Dashboard
        </a>
    </div>
    
    <!-- Informações da Credencial -->
    <div class="content-box mb-4">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Usuário:</strong> {{ passwordInfo.login or 'N/A' }}</p>
                <p><strong>Flags:</strong> 
                    {% if passwordInfo.flags %}
                        {% for flag in passwordInfo.flags %}
                        <span class="badge bg-flag me-1">{{ flag }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">Nenhuma flag</span>
                    {% endif %}
                </p>
            </div>
            <div class="col-md-6 text-md-end">
                <p><strong>ID da Credencial:</strong> {{ passwordInfo.id or 'N/A' }}</p>
                <p><strong>Status de Vazamento:</strong> 
                    {% if passwordInfo.status %}
                        <span class="badge bg-danger">VAZADA</span>
                    {% else %}
                        <span class="badge bg-success">Segura</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Histórico de Ações -->
    <h2 class="h4 mb-3">Histórico de Ações</h2>
    <div class="content-box p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="checkAllLogs" class="form-check-input">
                        </th>
                        <th>Data</th>
                        <th>Ação</th>
                        <th>Usuário</th>
                        <th>Detalhes</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody">
                    {% if passwordInfo and passwordInfo.logs %}
                        {% for log in passwordInfo.logs %}
                        <tr>
                            <td>
                                <input type="checkbox" name="logs" value="{{ log.id }}" 
                                       class="form-check-input log-checkbox">
                            </td>
                            <td class="text-nowrap">
                                {{ log.lastUse.strftime('%d/%m/%Y %H:%M') if log.lastUse else 'N/A' }}
                            </td>
                            <td>
                                <span class="badge bg-{{ log.severity_class if log.severity_class else 'secondary' }}">
                                    {{ log.action or 'Ação desconhecida' }}
                                </span>
                            </td>
                            <td>{{ log.user.login if log.user else 'Sistema' }}</td>
                            <td>{{ log.details or 'Sem detalhes' }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-secondary py-4">
                            <i class="bi bi-clock-history fs-1 d-block mb-3"></i>
                            <p class="mb-0">Nenhum log registrado para esta credencial.</p>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Botão de Excluir Logs -->
    {% if passwordInfo and passwordInfo.logs %}
    <button type="button" id="deleteLogsBtn" class="btn btn-danger mt-3" 
            data-password-id="{{ passwordInfo.id }}">
        <i class="bi bi-trash-fill"></i> Excluir Logs Selecionados
    </button>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkAll = document.getElementById('checkAllLogs');
    const checkboxes = document.querySelectorAll('.log-checkbox');
    const deleteBtn = document.getElementById('deleteLogsBtn');
    
    if (!checkAll || !deleteBtn) return;
    
    const passwordId = deleteBtn.getAttribute('data-password-id');

    // Selecionar/Desselecionar todos
    checkAll.addEventListener('change', function() {
        checkboxes.forEach(cb => cb.checked = checkAll.checked);
    });

    // Atualizar checkAll quando checkboxes individuais mudam
    checkboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            if (!this.checked) {
                checkAll.checked = false;
            } else {
                // Verifica se todos estão marcados
                const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
                checkAll.checked = allChecked;
            }
        });
    });

    // Excluir logs selecionados
    deleteBtn.addEventListener('click', function() {
        const selectedLogs = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        if (selectedLogs.length === 0) {
            if (window.customAlert) {
                window.customAlert.warning('Selecione pelo menos um log para excluir.');
            } else {
                alert('Selecione pelo menos um log para excluir.');
            }
            return;
        }

        // Confirmar exclusão
        const confirmMsg = `Tem certeza que deseja excluir ${selectedLogs.length} log${selectedLogs.length > 1 ? 's' : ''}?`;
        
        if (window.customAlert) {
            window.customAlert.confirm(confirmMsg, 'Confirmar Exclusão').then(confirmed => {
                if (confirmed) {
                    deleteLogs(selectedLogs);
                }
            });
        } else {
            if (confirm(confirmMsg)) {
                deleteLogs(selectedLogs);
            }
        }
    });
    
    // Função para deletar logs
    function deleteLogs(logIds) {
        const loading = window.showLoading ? window.showLoading('Excluindo logs...') : null;
        
        fetch('{{ url_for("moreInfo") }}', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'logs': logIds.join(',')
            })
        })
        .then(response => response.json())
        .then(data => {
            if (loading && loading.close) loading.close();
            
            if (data.success) {
                if (window.customAlert) {
                    window.customAlert.success(data.message || 'Logs excluídos com sucesso').then(() => {
                        window.location.reload();
                    });
                } else {
                    alert(data.message || 'Logs excluídos com sucesso');
                    window.location.reload();
                }
            } else {
                if (window.customAlert) {
                    window.customAlert.error(data.message || 'Erro ao excluir logs');
                } else {
                    alert(`Erro: ${data.message || 'Erro ao excluir logs'}`);
                }
            }
        })
        .catch(error => {
            if (loading && loading.close) loading.close();
            
            console.error('Erro na exclusão:', error);
            if (window.customAlert) {
                window.customAlert.error('Erro ao comunicar com o servidor.');
            } else {
                alert('Erro ao comunicar com o servidor.');
            }
        });
    }
});
</script>
{% endblock %}